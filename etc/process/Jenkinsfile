//
// The main Jenkinsfile for FIBO, defining the Build/Publish/Test/Deploy process that is
// executed for each push into the repository.
//
// Note that this file is in the so called "Declarative Pipeline" syntax
//
// See https://jenkins.io/doc/book/pipeline/jenkinsfile/
//
pipeline {

  agent none

  environment {
    FIBO_INFRA_BRANCH = 'master'
    LC_ALL = 'en_US.UTF-8'
    LANG = 'en_US.UTF-8'
    LANGUAGE = 'en_US.UTF-8'
  }

  options {

    buildDiscarder(
      logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5')
    )
    //
    // We let each stage running on each jenkins slave / agent decide what to check out or not
    //
    skipDefaultCheckout()
    //
    // Skip stages once the build status has gone to UNSTABLE.
    //
    skipStagesAfterUnstable()
    //
    // There must be SOME limit, if it hangs or whatever then that's a bug and therefore cancel the job.
    //
    timeout(time: 12, unit: 'HOURS')
    //
    // Prepend all console output generated by the Pipeline run with the time at which the line was emitted
    //
    //timestamps()
  }

  stages {

    stage('Prepare') {
      agent {
        label 'stardog'
      }
      environment {
        LC_ALL = 'en_US.UTF-8'
        LANG = 'en_US.UTF-8'
        LANGUAGE = 'en_US.UTF-8'
      }

      steps {
        echo "Cleaning workspace:"
        sh 'rm -rf ${WORKSPACE}/* || true'
        echo "Done cleaning"

        //
        // Copy the rdf-toolkit.jar file artifact from the rdf-toolkit-build job (pre-requisite for running publish script)
        //
        step([$class: 'CopyArtifact', filter: '**/rdf-toolkit.jar', fingerprintArtifacts: true, flatten: true, projectName: 'rdf-toolkit-build'])
        //
        // Copy the pellet jar from the build-pellet job
        //
        step([$class: 'CopyArtifact', filter: '**/pellet-cli-*.jar', fingerprintArtifacts: true, flatten: true, projectName: 'build-pellet', target: 'pellet'])
        //
        // Check out the fibo repo' content into the ./fibo directory
        //
        dir('fibo') {
          checkout scm
          echo 'Checked out fibo repo'
        }
        //
        // Then check out the fibo-infra repo content into the ./fibo-infra directory
        //
        dir('fibo-infra') {
          //
          // If you want to check out a specific version of fibo-infra add the "branch:" parameter
          //
          git branch: env.FIBO_INFRA_BRANCH, credentialsId: 'edmcjenkins_at_edmcouncil.org', url: 'git@github.com:edmcouncil/fibo-infra.git'
          //
          // git credentialsId: 'edmcjenkins_at_edmcouncil.org', url: 'git@github.com:edmcouncil/fibo-infra.git'
          echo "Checked out fibo-infra repo, branch ${env.FIBO_INFRA_BRANCH}"
          //
          // Stash all the tools in the bin directory
          //
          //stash includes: 'bin/**', name: 'infra-bin'
          //
          // Stash all the jenkins related stuff in the jenkins directory
          //
          //stash includes: 'jenkins/**', name: 'infra-jenkins'
        }
        //
        // Then run the init command on the fibo-publish script which will set all the GIT_* and JIRA_* vars
        // correctly and store their values in some .env files.
        //
        dir('fibo-infra') {
          echo 'Execute the publish-fibo.sh script (just to initialize the environment variables):'
          sh './jenkins/bin/publish-fibo.sh init'
          echo 'Finished executing the publish-fibo script (init section)'
        }
        initEnvironment()
        //
        // Now stash all files in the env directory for reuse in other workspaces on other agents/slaves
        //
        stash includes: 'env/**', name: 'environment'
        //
        // Then check out the LCC repo into the ./LCC directory
        //
        dir('LCC') {
          git url: 'https://github.com/edmcouncil/LCC.git', credentialsId: 'edmcjenkins'
          echo 'Checked out the LCC repo'
        }
        echo 'Checked it all out'
      }
    } // end of stage 'Prepare'

    stage('Build Product Ontology') {
      agent {
        label 'stardog'
      }

      steps {
        //
        // Execute the publish script
        //
        sh "./fibo-infra/jenkins/bin/publish-fibo.sh ontology"
        //
        // Now stash all files in the env directory for reuse in the other worker nodes
        // used by the next products
        //
        stash includes: '**', name: 'ontology-data'
      }
    } // end of stage 'Build Product Ontology'

    stage('Build Other Products') {
      parallel {
        stage("Build Widoco") {
          agent {
            label 'stardog'
          }
          steps {
            unstash 'ontology-data'
            sh "./fibo-infra/jenkins/bin/publish-fibo.sh widoco"
            stash includes: 'target/fibo/widoco/**', name: 'widoco-data'
          }
        }
        stage("Build Glossary") {
          agent {
            label 'stardog'
          }
          tools {
            //
            // This installs the NodeJS tools as they are configured in the "Global Tool Configuration"
            // of Jenkins: https://jenkins.edmcouncil.org/configureTools/
            //
            nodejs 'NodeJS'
          }
          steps {
            unstash 'ontology-data'
            sh "./fibo-infra/jenkins/bin/publish-fibo.sh glossary"
            stash includes: 'target/fibo/glossary/**', name: 'glossary-data'
          }
        }
        stage("Build Vocabulary") {
          agent {
            label 'stardog'
          }
          steps {
            unstash 'ontology-data'
            sh "./fibo-infra/jenkins/bin/publish-fibo.sh vocabulary"
            stash includes: 'target/fibo/vocabulary/**', name: 'vocabulary-data'
          }
        }
        stage("Build Datadictionary") {
          agent {
            label 'stardog'
          }
          steps {
            unstash 'ontology-data'
            sh "./fibo-infra/jenkins/bin/publish-fibo.sh datadictionary"
            stash includes: 'target/fibo/datadictionary/**', name: 'datadictionary'
          }
        }
      }
    } // end of stage 'Build Other Products'

    stage('Build Final Content') {
      agent {
        label 'stardog'
      }

      steps {
        unstash 'ontology-data'
        unstash 'widoco-data'
        unstash 'glossary-data'
        unstash 'vocabulary-data'
        unstash 'datadictionary-data'
        //
        // Now after all the above is done, make sure we run the final
        // publish step which zips it all up into the target directory
        //
        sh "./fibo-infra/jenkins/bin/publish-fibo.sh publish"

        //
        // Archive the artifacts generated by the publish-fibo.sh script
        //
        dir('target') {
          stash([
            name: 'publish-script-output-stardog-node',
            includes: '**',
            excludes: '**/.git, **/.gitignore',
            useDefaultExcludes: true
          ])
        }
      }
    } // end of stage 'Build Final Content'

    //
    // Run the publish on the master jenkins agent by just copying all the generated artifacts right into the workspace
    // on master and let NGINX just serve it from there.
    //
    // This workspace will never be "wiped" so it contains all the older versions as well, wiping this workspace
    // will be bad because we would lose all previously published versions
    //
    stage('Publish') {

      agent {
        label 'master'
      }
      environment {
        NGINX_SPEC_ROOT = '/mnt/jenkins-disk/spec.edmcouncil.org'
      }

      steps {

        echo "Cleaning workspace:"
        sh 'rm -rf .* * || true'
        echo "Done cleaning"

        sh 'test -d ${NGINX_SPEC_ROOT}'
        sh 'pwd'

        echo 'Unstashing the output of the publish-script as it ran on the stardog node'
        unstash 'publish-script-output-stardog-node'
        //
        // TODO: The cleanups below should be done by the publish script
        //
        sh 'find . -name \'.git\' -exec rm -rf {} \\; || true'
        sh 'find . -name \'.gitignore\' -exec rm -f {} \\; || true'
        sh 'find . -type d -name node_modules -exec rm -rf {} \\; || true'
        sh 'find . -type d -name build -exec rm -rf {} \\; || true'
        sh 'find . -type d -name \'temp*\' -exec rm -rf {} \\; || true'
        sh 'find . -type f -name \'temp*\' -exec rm -f {} \\; || true'
        sh 'ls -al'

        echo "Copy all generated content to ${env.NGINX_SPEC_ROOT}:"
        sh 'ls -al ${NGINX_SPEC_ROOT}/'
        sh 'cp -vr . ${NGINX_SPEC_ROOT}/ > published-files.log 2>&1'
        echo 'Successfully copied all files to destination, see published-files.log in the workspace'

        archiveArtifacts artifacts: '**/*.log', fingerprint: true
        sh 'find . -name \'*.log\' -exec rm -f {} \\; || true'

        //setGitHubPullRequestStatus context: 'fibo-publish', message: '', state: 'SUCCESS'
      }
    } // end of stage "Publish"
  } // end of stages

  post {
    failure {
      mail(
        to: 'jacobus.geluk@bnymellon.com',
        subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
        body: "Something is wrong with ${env.BUILD_URL}"
      )
    }
  }
} // end of pipeline

def initEnvironment() {

  //
  // Read the GIT and JIRA environment variables from files in the ./env directory
  // that have been created by the publish-fibo.sh script so that we can reuse that
  // logic elsewhere in the Jenkinsfile pipeline.
  //
  env.GIT_BRANCH    = readFile './env/GIT_BRANCH'.trim()
  env.GIT_TAG_NAME  = readFile './env/GIT_TAG_NAME'.trim()
  env.GIT_AUTHOR    = readFile './env/GIT_AUTHOR'.trim()
  env.GIT_COMMENT   = readFile './env/GIT_COMMENT'.trim()
  env.GIT_COMMIT    = readFile './env/GIT_COMMIT'.trim()
  env.JIRA_ISSUE    = readFile './env/JIRA_ISSUE'.trim()

  echo "GIT_BRANCH=${env.GIT_BRANCH}"
  echo "GIT_TAG_NAME=${env.GIT_TAG_NAME}"
  echo "GIT_AUTHOR=${env.GIT_AUTHOR}"
  echo "GIT_COMMENT=${env.GIT_COMMENT}"
  echo "GIT_COMMIT=${env.GIT_COMMIT}"
  echo "JIRA_ISSUE=${env.JIRA_ISSUE}"
}